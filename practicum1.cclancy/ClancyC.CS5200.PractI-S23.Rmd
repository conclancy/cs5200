---
title: 'Practicum I - Bird Strike Database'
author: 
- 'Connor Clancy'
date: 'Spring 2023'
---

## Connect to Database
```{r database_connection}
library(RMySQL)

db_user <- 'admin'
db_password <- 'Northea$tern23'
db_name <- 'practicumOne'
db_host <- 'cclancy-cs5200.cbowkysg1oyc.us-east-2.rds.amazonaws.com'
db_port <- 3306

dbcon <- dbConnect(MySQL(), user = db_user, password = db_password,
                   dbname = db_name, host = db_host, port = db_port)
```

## Create Helper R Functions 
```{r}
#' Method to check the existence of a foreign key and delete it if it exists.
#' If a foreign key already exists in a database this can cause problems for
#' dropping or altering the database.
#' 
#' @param fk_name the name of the foreign key to be checked
#' @return void
#' 
delete_fk <- function(fk_name) {
  # Query the database for the foreign key
  iac <- dbGetQuery(dbcon, 
    sprintf(
      "SELECT TRUE
      FROM information_schema.table_constraints
      WHERE constraint_name = '%s';", fk_name
    )
  )
  
  # If the foreign key exist, delete it
  if (nrow(iac) > 0) {
    dbExecute(dbcon, 
      sprintf(
        "ALTER TABLE incidents DROP FOREIGN KEY %s;", fk_name
      )
    )
  }  
}
```


## Create Database (Task 4)

### 4A - Incidents
```{sql dropTableIncidents, connection=dbcon}
DROP TABLE IF EXISTS incidents;
```

```{sql createTableIncidents, connection=dbcon}
CREATE TABLE incidents (
  rid INT AUTO_INCREMENT PRIMARY KEY,
  `dep.date` DATE,
  origin INT,
  airline INT, 
  aircraft VARCHAR(255) NOT NULL,
  `flight.phase` ENUM('takeoff', 'landing', 'inflight', 'unknown'),
  altitude INT,
  conditions INT, 
  warned TINYINT,
  CHECK(altitude>=0)
);
```

### 4B - Airports
```{sql dropTableAirports, connection=dbcon}
DROP TABLE IF EXISTS airports;
```

```{sql createTableAirports, connection=dbcon}
CREATE TABLE airports(
  aid INT AUTO_INCREMENT PRIMARY KEY,
  airportName VARCHAR(255) NOT NULL,
  airportCode VARCHAR(3),
  state VARCHAR(255)
);
```

### 4C - Foreign Key Incident Airports 
```{r dropFKIncidentsAirports}
delete_fk('FK_IncidentAirports')
```

```{sql connection=dbcon}
ALTER TABLE incidents
ADD CONSTRAINT FK_IncidentAirports 
FOREIGN KEY (origin) REFERENCES airports(aid);
```

### 4D - Conditions 
```{sql dropTableConditions, connection=dbcon}
DROP TABLE IF EXISTS conditions;
```

```{sql createTableConditions, connection=dbcon}
CREATE TABLE conditions(
  cid INT AUTO_INCREMENT PRIMARY KEY,
  `condition` VARCHAR(255) NOT NULL,
  explanation VARCHAR(255)
);
```

```{r dropFKIncidentsConditions}
delete_fk('FK_IncidentConditions')
```

```{sql dropIncidentConditionFK, connection=dbcon}
ALTER TABLE incidents
ADD CONSTRAINT FK_IncidentConditions 
FOREIGN KEY (conditions) REFERENCES conditions(cid);
```

### 4E - Airlines
```{sql dropTableAirlines, connection=dbcon}
DROP TABLE IF EXISTS airlines;
```

```{sql createTableAirlines, connection=dbcon}
CREATE TABLE airlines(
  eid INT AUTO_INCREMENT PRIMARY KEY,
  airlineName VARCHAR(255) NOT NULL,
  airlineCode VARCHAR(2),
  flag VARCHAR(255)
);
```

### 4F - Join Incidents Airlines 
```{r dropFKIncidentsAirlines}
delete_fk('FK_IncidentAirline')
```

```{sql dropFKIncidentsAirlinesFK, connection=dbcon}
ALTER TABLE incidents
ADD CONSTRAINT FK_IncidentAirline 
FOREIGN KEY (airline) REFERENCES airlines(eid);
```

### 4G - Test Code to ensure the tables are properly set up 

#### Test Inserts 

##### Airline Table Tests
```{sql testAirlinesInsert, connection=dbcon, eval=F}
INSERT INTO airlines (airlineName, airlineCode) VALUES 
  ('American Airlines', 'AA'),
  ('Delta', 'DL'),
  ('jetBlue', 'B6'),
  ('Southwest', 'WN'),
  ('United', 'UA');
```

```{sql testAirlinesSelect, connection=dbcon, eval=F}
SELECT 
  * 
FROM airlines;
```

##### Conditions Table Tests
```{sql testConditionsInsert, connection=dbcon, eval=F}
INSERT INTO conditions (`condition`, explanation) VALUES 
  ('clear', 'clear skies'),
  ('overcast', 'light clounds');
```

```{sql testConditionsSelect, connection=dbcon, eval=F}
SELECT 
  * 
FROM conditions;
```

##### Airport Table Tests
```{sql testAirportInserts, connection=dbcon, eval=F}
INSERT INTO airports (airportName, airportCode, state) VALUES 
  ('Boston Logan International Airport', 'BOS', 'MA'), 
  ('Seattle-Tacoma International Airport', 'SEA', 'WA'),
  ('Vancouver International Airport', 'YVR', 'BC');
```

```{sql testAirportSelect, connection=dbcon, eval=F}
SELECT 
  * 
FROM airports;
```

##### Incidents Table Tests
```{sql testIncidentsInsert, connection=dbcon}
INSERT INTO incidents (`dep.date`, origin, airline, aircraft, `flight.phase`, altitude, conditions, warned) VALUES 
  ('2023-02-24', 1, 3, 'A321-200', 'takeoff', 32, 2, 1),
  ('2023-02-26', 2, 1, '737 MAX 9', 'landing', 189, 1, 0);
```

```{sql testIncidentSelect, connection=dbcon, eval=F}
SELECT 
  * 
FROM incidents;
```

##### Clean-Up Test Data 
```{sql testIncidentsDelete, connection=dbcon, eval=F}
DELETE FROM incidents WHERE 1=1;
```

```{sql testAirlineDelete, connection=dbcon, eval=F}
DELETE FROM airlines WHERE 1=1;
```

```{sql testConditionDelete, connection=dbcon, eval=F}
DELETE FROM conditions WHERE 1=1;
```

```{sql testAirportsDelete, connection=dbcon, eval=F}
DELETE FROM airports WHERE 1=1;
```

## Load Data (Task 6)

## Show Table Heads (Task 7)

## States with the most bird strikes (Task 8)

## Airlines with above average bird strikes (Task 9)

## Birdstrikes by month and fligth phase (Task 10)

## Birdstrike Scatter Plot (Task 11)

## Stored Procedure for adding an incident to the database (Task 12)

