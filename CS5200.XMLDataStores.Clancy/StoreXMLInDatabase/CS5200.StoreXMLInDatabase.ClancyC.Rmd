---
title: "Assignment / Store XML in a Database"
author: "Connor Clancy - clancy.co@northeastern.edu"
date: "Spring 2023"
output: html_document
---
```{r imports}
library(knitr)
library(RSQLite)
library(sqldf)
library(XML)
```

## Question 1 - Schema ERD Schema
```{r image}
knitr::include_graphics('https://i.imgur.com/Q13TXFN.jpg')
```

## Question 2 - SQLite Schema
```{r sqlSetUp}
fpath = getwd()
dbfile="/books.db"

dbcon <- dbConnect(RSQLite::SQLite(), paste0(fpath, dbfile))
```

#### Authors Table
```{sql dropAuthorsTable, connection=dbcon}
DROP TABLE IF EXISTS authors;
```

```{sql createAuthorsTable, connection=dbcon}
CREATE TABLE authors (
  aid INTEGER PRIMARY KEY AUTOINCREMENT,
  firstName TEXT,
  lastName TEXT
);
```

```{sql testInsertAuthors, connection=dbcon}
INSERT INTO authors (firstName, lastName) VALUES 
  ('Connor', 'Clancy'),
  ('Jane', 'Doe');
```

```{sql connection=dbcon}
SELECT * FROM authors;
```

#### Genre Table
```{sql dropGenresTable, connection=dbcon}
DROP TABLE IF EXISTS genres;
```

```{sql createGenresTable, connection=dbcon}
CREATE TABLE genres (
  gid INTEGER PRIMARY KEY AUTOINCREMENT, 
  genre TEXT
);
```

```{sql testInstertGenresTable, connection=dbcon}
INSERT INTO genres(genre) VALUES
  ('history'),
  ('biography')
```

```{sql testGenres, connection=dbcon}
SELECT * FROM genres
```

#### Books Table
```{sql dropBooksTable, connection=dbcon}
DROP TABLE IF EXISTS books;
```

```{sql createBooksTable, connection=dbcon}
CREATE TABLE books (
  bid TEXT PRIMARY KEY,
  authorId INT,
  title TEXT, 
  genreId INT, 
  price REAL, 
  publishDate TEXT, 
  description TEXT, 
  FOREIGN KEY (authorId) REFERENCES authors(aid), 
  FOREIGN KEY (genreId) REFERENCES genres(gid)
);
```

```{sql testBookInserts, connection=dbcon}
INSERT INTO books (authorId, title, genreId, price, publishDate, description) 
  VALUES (1, "Test Book", 1, 23.99, "2023-01-01", "A test book"), 
  (1, "Second Test Book", 2, 4.00, "2022-02-02", "Another book");
```

```{sql connection=dbcon}
SELECT * FROM books;
```
#### Clear Test Data 
```{sql clearAuthors, connection=dbcon}
DELETE FROM authors WHERE 1=1;
```

```{sql clearGenres, connection=dbcon}
DELETE FROM genres WHERE 1=1;
```

```{sql clearBooks, connection=dbcon}
DELETE FROM books WHERE 1=1;
```

## Question 3 - Load XML Data into Database 
```{r loadXMLFile}
xmlDOM <- xmlParse("Books-v3.xml")
r <- xmlRoot(xmlDOM)
numBooks <- xmlSize(r)
```

```{r createRawDataframe}
rawDf <- data.frame(bid = vector(mode="integer", length = numBooks),
                      authorId = vector(mode="integer", length = numBooks),
                      title = vector(mode="character", length = numBooks),
                      genreId = vector(mode="integer", length = numBooks),
                      price = vector(mode="numeric", length = numBooks),
                      publishDate = vector(mode="character", length = numBooks),
                      description = vector(mode="character", length = numBooks)
                      )
```

```{r parseXMLData}
for (book in 1:numBooks) {
  
  # Book Id 
  xpBookId <- sprintf("//catalog/book[%s]/@id", book)
  bookId <- xpathSApply(r, xpBookId)[[1]]
  
  # Author
  xpBookAuth <- sprintf("//catalog/book[%s]/author", book)
  bookAuth <- xmlValue(xpathSApply(r, xpBookAuth)[[1]])
  
  # Title
  xpBookTitle <- sprintf("//catalog/book[%s]/title", book)
  bookTitle <- xmlValue(xpathSApply(r, xpBookTitle)[[1]])
  
  # Genre
  xpBookGenre <- sprintf("//catalog/book[%s]/genre", book)
  bookGenre <- xmlValue(xpathSApply(r, xpBookGenre)[[1]])
  
  # Price
  xpBookPrice <- sprintf("//catalog/book[%s]/price", book)
  bookPrice <- xmlValue(xpathSApply(r, xpBookPrice)[[1]])
  
  # Publish Date
  xpBookDate <- sprintf("//catalog/book[%s]/publish_date", book)
  bookDate <- xmlValue(xpathSApply(r, xpBookDate)[[1]])
    
  # Description
  xpBookDesc <- sprintf("//catalog/book[%s]/description", book)
  bookDesc <- xmlValue(xpathSApply(r, xpBookDesc)[[1]])
  
  # Write data to the dataframe
  rawDf[book, 1] <- bookId
  rawDf[book, 2] <- bookAuth
  rawDf[book, 3] <- bookTitle
  rawDf[book, 4] <- bookGenre
  rawDf[book, 5] <- bookPrice
  rawDf[book, 6] <- bookDate
  rawDf[book, 7] <- bookDesc
}
```

## Question 4 
```{r pkAuthors}

# get distinct author names
authorDf <- sqldf(
  "SELECT DISTINCT 
    0 AS aid,
    substr(authorId, instr(authorId, ',') + 1) AS firstName,
    substr(authorId, 0, instr(authorId, ',')) AS lastName, 
    authorId
   FROM rawDf
   ORDER BY substr(authorId, 0, instr(authorId, ','))"
)

# create a primary key for each author
numAuths <- nrow(authorDf)
authorDf[,1] <- seq(1, numAuths)

# replace the authors name with the PK in the books table data frame
for (r in 1:nrow(rawDf)) {
  aid <- authorDf$aid[
    which(authorDf$authorId == rawDf$authorId[r])
  ]
  
  # incidents with a blank airline get a NULL value
  if(length(aid) != 0) {
    rawDf$authorId[r] <- aid
  } else {
    rawDf$authorId[r] <- NA
  }
}

authorDf <- sqldf(
  "SELECT DISTINCT 
    aid,
    firstName,
    lastName
   FROM authorDf
   ORDER BY aid"
)
```

```{r pkGenres}

# get a distinct list of genres 
genreDf <- sqldf(
  "SELECT DISTINCT 
    0 AS gid,
    genreId AS genre
   FROM rawDf
   ORDER BY genreId"
)

# create a primary key for each genre
numGenres <- nrow(genreDf)
genreDf[,1] <- seq(1, numGenres)

# replace the genre names with the PK in the books table data frame 
for (r in 1:nrow(rawDf)) {
  gid <- genreDf$gid[
    which(genreDf$genre == rawDf$genreId[r])
  ]
  
  # incidents with a blank airline get a NULL value
  if(length(gid) != 0) {
    rawDf$genreId[r] <- gid
  } else {
    rawDf$genreId[r] <- NA
  }
}
```

```{r writeDfToDb}
dbWriteTable(dbcon, "books", rawDf, overwrite = F, append = T, row.names = FALSE)
dbWriteTable(dbcon, "genres", genreDf, overwrite = F, append = T, row.names = FALSE)
dbWriteTable(dbcon, "authors", authorDf, overwrite = F, append = T, row.names = FALSE)
```

#### Preview Populated Tables
```{sql testBooksWritten, connection=dbcon}
SELECT * FROM books LIMIT 3;
```

```{sql testAuthorsWritten, connection=dbcon}
SELECT * FROM authors LIMIT 3;
```

```{sql testGenresWritten, connection=dbcon}
SELECT * FROM genres LIMIT 3;
```
## Question 5

### 5A - Genres with at least 3 books
```{sql connection=dbcon, threeBooks}
SELECT 
  COUNT(1) AS genres
FROM (
  SELECT 
    genreId, 
    COUNT(bid) AS bookCount
  FROM books
  GROUP BY genreId
) AS sub
WHERE bookCount > 3
```

### 5B - Oldest Year of Publication
```{sql connection=dbcon, oldPub}
SELECT 
  MIN(strftime('%Y', publishDate)) as publishYear
FROM books
```

### 5C - Number of Books and Average Price by Genre
```{sql connection=dbcon, genreStats}
SELECT 
  g.genre, 
  COUNT(b.bid) As books, 
  AVG(b.price) AS avgPrice
FROM books AS b
INNER JOIN genres AS g 
  ON b.genreId = g.gid
GROUP BY 
  g.genre
```

## 5D - Price Outliers 
```{sql connection=dbcon, priceOutliers}
SELECT 
  title, 
  firstName, 
  lastName
FROM books 
INNER JOIN authors 
  ON authorId = aid
WHERE price < (SELECT AVG(price) * .8 FROM books)
  OR price > (SELECT AVG(price) * 1.2 FROM books)
```
